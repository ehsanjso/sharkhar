# 2026-02-20 - Gateway Stability Fix & Trading Agent Enhancements

## Critical Bug Fixed: Gateway Crashes Every 60s

### Problem
- Gateway crashed every ~60 seconds with `TypeError: fetch failed`
- Also seeing `AbortError: This operation was aborted`
- Session lock timeouts occurred frequently
- Error had NO context about what was being fetched
- Started happening after recent Clawdbot updates

### Failed Attempts
1. ❌ Disabled `experimental.sessionMemory` - crashes returned
2. ❌ Reduced `maxConcurrent` from 4 to 2 - still crashing
3. ❌ Disabled Tavily skill - still crashing
4. ❌ Stopped BTC trading agent - still crashing
5. ❌ Disabled all 8 cron jobs - still crashing

### Root Cause Discovery
- Found via GitHub issues and systematic testing
- Telegram Bot API has **100 command limit**
- Clawdbot was registering **90+ skills as slash commands**
- Every gateway restart triggered `setMyCommands` API call
- This caused `BOT_COMMANDS_TOO_MUCH` error
- Telegram's retry loop triggered `fetch failed` crashes

### Solution
```json
{
  "commands": {
    "nativeSkills": false
  }
}
```

**Impact:**
- ✅ Core commands still work (`/status`, `/help`, etc.)
- ✅ Skills still work via text input
- ✅ Gateway completely stable (2+ min uptime, previously crashed every 60s)
- ❌ No slash auto-complete for skills (acceptable tradeoff)

**Lesson:** When debugging crashes, disable Telegram temporarily to isolate channel-specific issues

---

## Trading Agent: Quantitative Framework Integration

### Skills Loaded
Successfully integrated skills for trading agent via proper `sessions_send` approach:

1. **quant-trading** (29 files) - Ernest Chan's "Quantitative Trading" book
2. **algo-trading-strategies** (27 files) - Ernest Chan's "Algorithmic Trading" book ← NEW!
3. **financial-market-analysis** - Market sentiment
4. **yahoo-finance** - Price data

**New skill highlights (algo-trading-strategies):**
- Statistical tests (ADF, Johansen, Hurst exponent, variance ratio)
- Mean-reversion strategies (pairs, ETF pairs, Bollinger, Kalman, buy-on-gap)
- Momentum strategies (time-series, cross-sectional)
- CPPI, roll returns, backtesting pitfalls

### Technical Implementation

**Problem:** BTC agent using OpenAI Chat Completions endpoint didn't load skills

**Solution:** Switched to `sessions_send` via `/tools/invoke` endpoint
- Gives trading agent full Clawdbot runtime
- Skills properly loaded
- Required enabling `tools.agentToAgent.enabled: true`

**Code changes:**
1. Fixed Python f-string formatting bug (JSON in f-strings needs `{{}}`)
2. Fixed Gateway response parsing (nested JSON structure)
3. Updated system prompt to **require** Kelly + EV + Edge calculations on every decision

### Quantitative Analysis Results

**Before:**
```
"reasoning": "Conflicting signals, skip"
```

**After:**
```
"reasoning": "Kelly DOWN f=0.121 (5.5% edge: 60% vs 54.5%), Kelly UP f=0.044 (4.5% edge) - BOTH below 15% threshold. Late window demands 75%+ confidence. Skip."
```

**What the agent now calculates:**
- ✅ Kelly position size: `f = (bp - q) / b`
- ✅ Edge: Your probability - Market probability
- ✅ Expected value: `EV = P(win) × payout - P(loss) × stake`
- ✅ Threshold checks: 15% minimum edge required
- ✅ Time-based requirements: Late window needs 75%+ confidence

**Lesson:** Skills are loaded but need explicit prompting to be used. The agent had access but wasn't citing frameworks until we added "MANDATORY QUANTITATIVE ANALYSIS" section to system prompt.

---

## System Configuration Changes

1. **Disabled experimental.sessionMemory** - Was causing issues
2. **Reduced maxConcurrent** - 4 → 2 (lower resource usage)
3. **Enabled agentToAgent messaging** - Required for `sessions_send`
4. **Disabled nativeSkills** - Fixed Telegram command limit issue
5. **Disabled all cron jobs temporarily** - For debugging (can re-enable)
6. **Disabled Tavily skill** - For debugging (can re-enable)

---

## Next Steps

1. **Re-enable cron jobs** - Now that gateway is stable
2. **Re-enable Tavily** - If needed for web search
3. **Restart BTC trading agent** - With full quantitative framework
4. **Monitor for Kelly/EV citations** - Verify agent uses statistical validation naturally
5. **Consider adding explicit statistical validation prompts** - Hurst exponent, ADF test, half-life calculations

---

## Files Modified

**Trading Agent:**
- `/home/ehsanjso/clawd/projects/polymarket-v3/agents/btc_5min/btc_agent.py` - Added quantitative analysis requirements
- `/home/ehsanjso/clawd/projects/polymarket-v3/agents/btc_5min/clawdbot_subagent.py` - Switched to `sessions_send`

**Skills Installed:**
- `/home/ehsanjso/clawd-trading/skills/algo-trading-strategies/` - 27 interconnected markdown files

**Configuration:**
- `~/.clawdbot/clawdbot.json` - Multiple patches applied

---

## References

**GitHub Issues:**
- https://github.com/windkh/node-red-contrib-telegrambot/issues/192
- https://github.com/openclaw/openclaw/issues/1484
- https://github.com/tdlib/telegram-bot-api/issues/98

**Telegram Limits:**
- Bot commands: 100 maximum
- Our skills: 52 bundled + 38 user = 90 skills + native commands = exceeds limit
