# 2026-02-18 - Polymarket Bot V3 Goes Live

## Major Accomplishments

### Bot Fixes & Features Added
1. **Window Detection Fix** - Changed from `get_next_5min_window()` to `get_current_5min_window()` - was detecting windows late
2. **Unicode Crash Fix** - Replaced ✓ ✗ → with ASCII (WIN, LOSS, ->) - PM2 runs with latin-1 encoding
3. **Market Orders** - Switched from limit orders (sat unfilled) to FOK market orders via `execute_market_buy()` - orders now fill instantly
4. **No Hedging** - Added `current_window_side` tracking to prevent betting both UP and DOWN in same window
5. **Balance Protection** - Added pre-bet check: `balance - BET_AMOUNT >= MIN_BALANCE`
6. **Position Tracking** - Added `get_live_positions()` and `check_and_report_positions()` for live mode
7. **Auto-Redemption** - Added `auto_redeem_positions()` that triggers on window change - VERIFIED WORKING!

### Key Code Locations
- Main bot: `~/clawd/projects/polymarket-v3/agents/btc_5min/btc_agent.py`
- Redemption: `~/clawd/projects/polymarket-v3/agents/btc_5min/redeem.py`
- Polymarket API: `~/clawd/projects/polymarket-v3/agents/polymarket/polymarket.py`
- Run script: `~/clawd/projects/polymarket-v3/run-agent.sh` (--live --duration 480)

### Config (in btc_agent.py)
- BET_AMOUNT = $3.00
- MIN_BALANCE = $2.00
- MIN_CONFIDENCE = 0.60
- Model: sonnet

### Trading Results Today
- Started: $12.18
- Added by Ehsan: +$5.00
- Current: ~$10.59
- Multiple wins and losses, system now stable

### Key Learnings
1. Polymarket BTC 5-min markets have thin liquidity - need aggressive pricing
2. Polymarket does NOT auto-redeem - must call redeem contract manually
3. FOK (Fill or Kill) orders work better than GTC limit orders
4. Position resolution takes 5-10 mins after window close

### Wallet
- Address: `0x923C9c79ADF737A878f6fFb4946D7da889d78E1d`
- Running via PM2: `pm2 restart btc-agent`

## Status
Bot is LIVE and fully automated:
- Places bets with market orders
- Tracks pending positions  
- Auto-redeems winnings on window change
- Ehsan verified auto-redeem working at 1:50 PM EST

---

## Order Book Investigation (2:30 PM EST)

### Slippage Protection Added
- `MAX_SLIPPAGE = 0.10` (10% above best ask)
- Skips trades if liquidity insufficient within tolerance
- Logs best_ask vs max_price for transparency

### Key Findings on Polymarket BTC 5-min Order Books

1. **Our code reads correctly** - `asks[-1]` gets best (lowest) ask price
   - Order book sorted: 0.99 → 0.57 (highest to lowest)
   
2. **Liquidity is time-dependent:**
   - Early in window: tight spreads (~1%)
   - Late in window (last 60s): spreads widen to 10%+
   - Market makers pull liquidity as window closes

3. **No arbitrage/hidden liquidity:**
   - DOWN ask ≈ 1 - UP bid (perfectly arb-free)
   - DOWN + UP = 1.00

4. **Display price ≠ executable price:**
   - Polymarket UI shows midpoint/last trade
   - Actual best ask can be much higher

### Recommendation (for future)
- Bet earlier in window for tighter spreads
- Current 10% slippage cap is reasonable
- No code changes needed - we're reading order book correctly
