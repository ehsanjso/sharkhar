# 2026-02-17 Session Notes

## Polymarket Bot - Major Audit & Fixes

### Transaction Analysis
- Ehsan shared CSV of Polymarket transactions from wallet `0x923C9c79ADF737A878f6fFb4946D7da889d78E1d`
- Session 3:42-5:51 AM UTC: 17 trades ($211.87), 7 redemptions ($196.77)
- **Net P&L: -$15.10** (-7.1% ROI)
- Win rate: ~41% (7 wins / 17 trades)

### Strategy Performance (from bot data)
Best performers:
- **vol-regime**: 88.5% win rate, +$642 P&L
- **ensemble**: 76.5% win rate, +$287 P&L  
- **breakout**: 100% win rate, +$93 P&L

All strategies were in PAPER mode, not LIVE mode.

### Code Audit - Race Conditions Fixed (12+ issues)

**src/ files:**
1. `redemption.ts` - Added FileMutex for file ops, input validation, duplicate detection
2. `multi-bot.ts` - SessionMutex for thread-safe sessions, stale cleanup, tick guards
3. `btc-price.ts` - WebSocket reconnect race fix, ping/pong, Binance fallback
4. `multi-price-tracker.ts` - Same fixes + backup REST polling
5. `polymarket.ts` - Retry logic, request timeouts, safe JSON parsing
6. `market-discovery.ts` - Request timeouts, safe parsing, watcher cleanup
7. `bot.ts` - Concurrent ops prevention, null checks

**dashboard/ files:**
8. `live-trading.ts` - Concurrent initialization prevention
9. `bet-tracker.ts` - Concurrent redemption check, use centralized RPC
10. `news-research.ts` - **Command injection vulnerability fixed** (sanitize inputs)

### New Feature: Profitability Filter (`src/profitability.ts`)
Ensures every trade has positive expected value after fees:
- Gas costs: ~$0.04 per round trip
- Spread: ~1.5%
- **Min bet: $5** (keeps cost ratio under 3%)
- **Min probability: 53%**
- **Min edge: 3%**

Breakeven: $5 bet needs 51.2% win rate, $20 bet needs 50.8%

### Git Commits
```
0b98946 fix: additional race condition and security fixes
4c1cdce feat: add profitability filter to ensure positive EV after fees
ea448e0 fix: comprehensive audit and race condition fixes
```

## 02:00 PM — Daily Research: Backtesting Frameworks for Prediction Markets

**Topic selected:** Backtesting frameworks to validate Polymarket strategies before live trading

**Why this topic:**
- Bot audit complete, vol-regime (88.5%) and ensemble (76.5%) are top performers
- Paper trading takes days; backtesting takes minutes
- Could have prevented the $110 over-betting loss on Feb 16

**Key findings:**
1. **VectorBT recommended** — Fastest, tests thousands of strategy variants in seconds
2. **Pi 5 compatible** — Uses ~300-500MB RAM, works fine on 8GB Pi
3. **Polymarket data** — Use CLOB API or build JSONL collector in btc-price.ts
4. **Binary outcome math** — Prediction markets need custom payoff functions (not standard stock P&L)

**Practical next steps:**
- Modify `btc-price.ts` to save historical prices as JSONL
- Install VectorBT: `pip install vectorbt`
- Backtest vol-regime to validate the 88.5% win rate claim
- Run parameter optimization on window sizes and thresholds

**Research saved:** `memory/research/2026-02-17-backtesting-prediction-markets.md`

---

### Unredeemed Bets Status
- 5 BTC up/down bets checked - all were LOSSES (no tokens to redeem)
- Wallet balance: $44.00 USDC
- 1 pending bet on "US revenue <$100B" ($2.44) - not resolved yet

### Recommendations Given
- Fund vol-regime, ensemble, breakout (best performers)
- Disable rsi-divergence, stoikov, regime, scaled-betting (not profitable)

## Spare Capacity Work (12:00 PM)
- Added `--json` flag to `polybot status` command
- Enables JSON output for integrations: `polybot status --json [-v]`
- Commit: `a3067556 feat(bot): add --json output to status command`

## Memory Compaction Script Enhancements (11:00 PM)
Sub-agent session completed:
- Added `--model` flag to `memory-compact.sh` (defaults to Haiku for cost savings)
- Added retry logic with exponential backoff (3 attempts)
- Added file truncation for large files (>10KB)
- Updated README documentation
- 3 commits made locally (need push after rebase)

**Pending for Ehsan:**
- Switch Pill Reminder cron to Haiku: `clawdbot cron edit 0aac7693 --model haiku`
- Test memory compaction: `cd ~/clawd && ./scripts/memory-compact.sh`
- Push commits: `cd ~/clawd && git pull --rebase origin main && git push`
