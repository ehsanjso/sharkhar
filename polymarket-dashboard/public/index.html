<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polymarket Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes pulse-green { 0%, 100% { background-color: rgb(34 197 94 / 0.2); } 50% { background-color: rgb(34 197 94 / 0.4); } }
    @keyframes pulse-red { 0%, 100% { background-color: rgb(239 68 68 / 0.2); } 50% { background-color: rgb(239 68 68 / 0.4); } }
    .pulse-up { animation: pulse-green 2s ease-in-out infinite; }
    .pulse-down { animation: pulse-red 2s ease-in-out infinite; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.05); }
    .live-border { border-left: 4px solid #22c55e; }
    .paper-border { border-left: 4px solid #a855f7; }
    .live-badge { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
    .paper-badge { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
  </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-green-400 via-purple-400 to-pink-500 bg-clip-text text-transparent">
          üìä Polymarket Dashboard
        </h1>
        <p class="text-gray-400 text-sm mt-1">Live & Paper Trading</p>
      </div>
      <div class="flex items-center gap-4">
        <span id="clock" class="text-sm font-mono text-gray-400"></span>
        <button onclick="refreshAll()" class="px-3 py-1 rounded bg-gray-800 hover:bg-gray-700 text-sm">üîÑ Refresh</button>
      </div>
    </header>

    <!-- Combined Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="glass rounded-xl p-4 border border-gray-800">
        <p class="text-gray-400 text-xs">Total Portfolio</p>
        <p id="total-value" class="text-2xl font-bold text-white">$0.00</p>
        <p id="total-pnl" class="text-sm text-green-400">+$0.00</p>
      </div>
      <div class="glass rounded-xl p-4 border border-gray-800">
        <p class="text-gray-400 text-xs">Live Value</p>
        <p id="live-total" class="text-2xl font-bold text-green-400">$0.00</p>
      </div>
      <div class="glass rounded-xl p-4 border border-gray-800">
        <p class="text-gray-400 text-xs">Paper Value</p>
        <p id="paper-total" class="text-2xl font-bold text-purple-400">$0.00</p>
      </div>
      <div class="glass rounded-xl p-4 border border-gray-800">
        <p class="text-gray-400 text-xs">Total Win Rate</p>
        <p id="total-winrate" class="text-2xl font-bold">‚Äî</p>
      </div>
    </div>

    <!-- ========================== LIVE MARKETS SECTION ========================== -->
    <div class="mb-12">
      <div class="flex items-center gap-3 mb-6">
        <span class="live-badge px-3 py-1 rounded-full text-sm font-bold text-white shadow-lg">üíµ LIVE</span>
        <h2 class="text-2xl font-bold text-green-400">Live Markets</h2>
        <span class="text-gray-500 text-sm">Real Money Trading</span>
      </div>

      <!-- Live Portfolio Stats -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
        <div class="glass rounded-lg p-4 border border-green-900/50 live-border">
          <p class="text-gray-400 text-xs">Cash</p>
          <p id="live-cash" class="text-xl font-bold text-green-400">$0.00</p>
        </div>
        <div class="glass rounded-lg p-4 border border-green-900/50 live-border">
          <p class="text-gray-400 text-xs">Positions Value</p>
          <p id="live-positions-value" class="text-xl font-bold">$0.00</p>
        </div>
        <div class="glass rounded-lg p-4 border border-green-900/50 live-border">
          <p class="text-gray-400 text-xs">P&L</p>
          <p id="live-pnl" class="text-xl font-bold text-green-400">+$0.00</p>
        </div>
        <div class="glass rounded-lg p-4 border border-green-900/50 live-border">
          <p class="text-gray-400 text-xs">Win Rate</p>
          <p id="live-winrate" class="text-xl font-bold">‚Äî</p>
        </div>
        <div class="glass rounded-lg p-4 border border-green-900/50 live-border">
          <p class="text-gray-400 text-xs">Record</p>
          <p id="live-record" class="text-xl font-bold">0W / 0L</p>
        </div>
      </div>

      <!-- Live Open Positions -->
      <div class="glass rounded-xl p-5 border border-green-900/30 live-border mb-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-green-400">üìà Open Positions</h3>
          <span id="live-positions-count" class="text-sm text-gray-500">0 positions</span>
        </div>
        <div id="live-positions" class="space-y-3">
          <p class="text-gray-500 text-sm">No live positions</p>
        </div>
      </div>

      <!-- Live Recent Trades -->
      <div class="glass rounded-xl p-5 border border-green-900/30 live-border">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-green-400">üìú Recent Trades</h3>
          <span id="live-trades-count" class="text-sm text-gray-500">0 trades</span>
        </div>
        <div id="live-trades" class="space-y-2 max-h-64 overflow-y-auto">
          <p class="text-gray-500 text-sm">No live trades yet</p>
        </div>
      </div>
    </div>

    <!-- ========================== PAPER MARKETS SECTION ========================== -->
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-6">
        <span class="paper-badge px-3 py-1 rounded-full text-sm font-bold text-white shadow-lg">üìù PAPER</span>
        <h2 class="text-2xl font-bold text-purple-400">Paper Markets</h2>
        <span class="text-gray-500 text-sm">Simulation Mode</span>
      </div>

      <!-- Paper Portfolio Stats -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
        <div class="glass rounded-lg p-4 border border-purple-900/50 paper-border">
          <p class="text-gray-400 text-xs">Cash</p>
          <p id="paper-cash" class="text-xl font-bold text-purple-400">$0.00</p>
        </div>
        <div class="glass rounded-lg p-4 border border-purple-900/50 paper-border">
          <p class="text-gray-400 text-xs">Positions Value</p>
          <p id="paper-positions-value" class="text-xl font-bold">$0.00</p>
        </div>
        <div class="glass rounded-lg p-4 border border-purple-900/50 paper-border">
          <p class="text-gray-400 text-xs">P&L</p>
          <p id="paper-pnl" class="text-xl font-bold text-purple-400">+$0.00</p>
        </div>
        <div class="glass rounded-lg p-4 border border-purple-900/50 paper-border">
          <p class="text-gray-400 text-xs">Win Rate</p>
          <p id="paper-winrate" class="text-xl font-bold">‚Äî</p>
        </div>
        <div class="glass rounded-lg p-4 border border-purple-900/50 paper-border">
          <p class="text-gray-400 text-xs">Record</p>
          <p id="paper-record" class="text-xl font-bold">0W / 0L</p>
        </div>
      </div>

      <!-- Paper Open Positions -->
      <div class="glass rounded-xl p-5 border border-purple-900/30 paper-border mb-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-purple-400">üìà Open Positions</h3>
          <span id="paper-positions-count" class="text-sm text-gray-500">0 positions</span>
        </div>
        <div id="paper-positions" class="space-y-3">
          <p class="text-gray-500 text-sm">No paper positions</p>
        </div>
      </div>

      <!-- Paper Recent Trades -->
      <div class="glass rounded-xl p-5 border border-purple-900/30 paper-border">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-purple-400">üìú Recent Trades</h3>
          <span id="paper-trades-count" class="text-sm text-gray-500">0 trades</span>
        </div>
        <div id="paper-trades" class="space-y-2 max-h-64 overflow-y-auto">
          <p class="text-gray-500 text-sm">No paper trades yet</p>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="text-center text-gray-600 text-sm mt-8">
      <p>Data refreshes automatically ‚Ä¢ Last update: <span id="last-update">‚Äî</span></p>
    </footer>
  </div>

  <script>
    // Separate state for live and paper trading
    const state = {
      live: {
        cash: 0,
        startingCash: 0,
        positions: [],
        trades: [],
        wins: 0,
        losses: 0
      },
      paper: {
        cash: 0,
        startingCash: 0,
        positions: [],
        trades: [],
        wins: 0,
        losses: 0
      }
    };

    // Load state from localStorage
    function loadState() {
      const savedLive = localStorage.getItem('polymarket-live');
      const savedPaper = localStorage.getItem('polymarket-paper');
      
      if (savedLive) {
        Object.assign(state.live, JSON.parse(savedLive));
      }
      if (savedPaper) {
        Object.assign(state.paper, JSON.parse(savedPaper));
      }
    }

    function saveState() {
      localStorage.setItem('polymarket-live', JSON.stringify(state.live));
      localStorage.setItem('polymarket-paper', JSON.stringify(state.paper));
    }

    // Fetch data from API (if available) or use local state
    async function fetchData() {
      try {
        // Try to fetch from bot's data directory via API
        const [portfolioRes, betsRes] = await Promise.all([
          fetch('/api/portfolio').catch(() => null),
          fetch('/api/bets').catch(() => null)
        ]);
        
        if (portfolioRes?.ok && betsRes?.ok) {
          const portfolio = await portfolioRes.json();
          const bets = await betsRes.json();
          
          // Map bot data to paper trading (since bot is paper trading)
          state.paper.cash = portfolio.cash || 0;
          state.paper.startingCash = portfolio.starting_cash || 50;
          state.paper.wins = portfolio.total_wins || 0;
          state.paper.losses = portfolio.total_losses || 0;
          
          // Separate pending and resolved bets
          state.paper.positions = bets.filter(b => !b.resolved);
          state.paper.trades = bets.filter(b => b.resolved);
        }
      } catch (e) {
        console.log('API not available, using local state');
      }
      
      saveState();
    }

    // Calculate portfolio values
    function calculateValues(mode) {
      const data = state[mode];
      const positionsValue = data.positions.reduce((sum, p) => sum + (p.amount || 0), 0);
      const totalValue = data.cash + positionsValue;
      const pnl = totalValue - data.startingCash;
      const totalBets = data.wins + data.losses;
      const winRate = totalBets > 0 ? (data.wins / totalBets * 100) : null;
      
      return { positionsValue, totalValue, pnl, winRate };
    }

    // Format currency
    function formatCurrency(val, showSign = false) {
      const sign = showSign && val >= 0 ? '+' : '';
      return `${sign}$${Math.abs(val).toFixed(2)}`;
    }

    // Render position card
    function renderPosition(pos, mode) {
      const colorClass = pos.side === 'YES' ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30';
      const textClass = pos.side === 'YES' ? 'text-green-400' : 'text-red-400';
      const question = pos.market_question || pos.question || 'Unknown market';
      const shortQ = question.length > 50 ? question.substring(0, 47) + '...' : question;
      
      return `
        <div class="p-3 rounded-lg ${colorClass} border">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <p class="text-sm text-gray-300">${shortQ}</p>
              <p class="text-xs text-gray-500 mt-1">
                ${pos.outcome || 'Position'} 
                <span class="${textClass} font-medium">${pos.side}</span> 
                @ ${((pos.price || 0) * 100).toFixed(0)}%
              </p>
            </div>
            <div class="text-right">
              <p class="font-mono font-medium">$${(pos.amount || 0).toFixed(2)}</p>
              <p class="text-xs text-gray-500">${(pos.shares || 0).toFixed(2)} shares</p>
            </div>
          </div>
        </div>
      `;
    }

    // Render trade card
    function renderTrade(trade) {
      const won = trade.won;
      const bgClass = won ? 'bg-green-500/10' : 'bg-red-500/10';
      const icon = won ? '‚úì' : '‚úó';
      const iconClass = won ? 'text-green-400' : 'text-red-400';
      const pnl = (trade.payout || 0) - (trade.amount || 0);
      const question = trade.market_question || trade.question || 'Unknown';
      const shortQ = question.length > 40 ? question.substring(0, 37) + '...' : question;
      const date = trade.resolved_at ? new Date(trade.resolved_at).toLocaleDateString() : '‚Äî';
      
      return `
        <div class="flex justify-between items-center p-2 rounded ${bgClass}">
          <div class="flex items-center gap-2">
            <span class="${iconClass} text-lg">${icon}</span>
            <div>
              <p class="text-sm">${shortQ}</p>
              <p class="text-xs text-gray-500">${trade.outcome} ${trade.side} @ ${((trade.price || 0) * 100).toFixed(0)}% ‚Ä¢ ${date}</p>
            </div>
          </div>
          <span class="font-mono ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
            ${formatCurrency(pnl, true)}
          </span>
        </div>
      `;
    }

    // Update UI for a specific mode
    function renderMode(mode) {
      const data = state[mode];
      const vals = calculateValues(mode);
      const prefix = mode;
      
      // Stats
      document.getElementById(`${prefix}-cash`).textContent = formatCurrency(data.cash);
      document.getElementById(`${prefix}-positions-value`).textContent = formatCurrency(vals.positionsValue);
      document.getElementById(`${prefix}-total`).textContent = formatCurrency(vals.totalValue);
      
      const pnlEl = document.getElementById(`${prefix}-pnl`);
      pnlEl.textContent = formatCurrency(vals.pnl, true);
      pnlEl.className = `text-xl font-bold ${vals.pnl >= 0 ? (mode === 'live' ? 'text-green-400' : 'text-purple-400') : 'text-red-400'}`;
      
      document.getElementById(`${prefix}-winrate`).textContent = vals.winRate !== null ? `${vals.winRate.toFixed(0)}%` : '‚Äî';
      document.getElementById(`${prefix}-record`).textContent = `${data.wins}W / ${data.losses}L`;
      
      // Positions
      const positionsEl = document.getElementById(`${prefix}-positions`);
      document.getElementById(`${prefix}-positions-count`).textContent = `${data.positions.length} position${data.positions.length !== 1 ? 's' : ''}`;
      
      if (data.positions.length === 0) {
        positionsEl.innerHTML = `<p class="text-gray-500 text-sm">No ${mode} positions</p>`;
      } else {
        positionsEl.innerHTML = data.positions.map(p => renderPosition(p, mode)).join('');
      }
      
      // Trades
      const tradesEl = document.getElementById(`${prefix}-trades`);
      document.getElementById(`${prefix}-trades-count`).textContent = `${data.trades.length} trade${data.trades.length !== 1 ? 's' : ''}`;
      
      if (data.trades.length === 0) {
        tradesEl.innerHTML = `<p class="text-gray-500 text-sm">No ${mode} trades yet</p>`;
      } else {
        tradesEl.innerHTML = data.trades.slice(-15).reverse().map(renderTrade).join('');
      }
    }

    // Render combined totals
    function renderTotals() {
      const liveVals = calculateValues('live');
      const paperVals = calculateValues('paper');
      
      const totalValue = liveVals.totalValue + paperVals.totalValue;
      const totalPnl = liveVals.pnl + paperVals.pnl;
      const totalWins = state.live.wins + state.paper.wins;
      const totalLosses = state.live.losses + state.paper.losses;
      const totalBets = totalWins + totalLosses;
      const totalWinRate = totalBets > 0 ? (totalWins / totalBets * 100) : null;
      
      document.getElementById('total-value').textContent = formatCurrency(totalValue);
      
      const totalPnlEl = document.getElementById('total-pnl');
      totalPnlEl.textContent = formatCurrency(totalPnl, true);
      totalPnlEl.className = `text-sm ${totalPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
      
      document.getElementById('total-winrate').textContent = totalWinRate !== null ? `${totalWinRate.toFixed(0)}%` : '‚Äî';
    }

    // Full render
    function render() {
      renderMode('live');
      renderMode('paper');
      renderTotals();
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
    }

    // Clock
    function updateClock() {
      document.getElementById('clock').textContent = new Date().toLocaleTimeString();
    }

    // Refresh all data
    async function refreshAll() {
      await fetchData();
      render();
    }

    // Initialize
    loadState();
    render();
    updateClock();

    setInterval(updateClock, 1000);
    setInterval(refreshAll, 60000); // Refresh every minute
    
    // Initial fetch
    fetchData().then(render);
  </script>
</body>
</html>
